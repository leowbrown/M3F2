const express=require("express"),app=express(),mongoose=require("mongoose"),passport=require("passport"),bodyParser=require("body-parser"),User=require("./models/user"),Post=require("./models/post");app.use(express.static(__dirname+"/public"));const LocalStrategy=require("passport-local"),passportLocalMongoose=require("passport-local-mongoose"),twig=require("twig");app.set("view engine","html"),app.engine("html",twig.__express),app.set("views","views");const mongourl="mongodb+srv://leoAdmin:Placeholder12_@cluster0.t6qcs.mongodb.net/classPort?retryWrites=true&w=majority";mongoose.connect(mongourl,{useUnifiedTopology:!0}),app.use(require("express-session")({secret:"any normal word",resave:!1,saveUninitialized:!1})),passport.serializeUser(User.serializeUser()),passport.deserializeUser(User.deserializeUser()),passport.use(new LocalStrategy(User.authenticate())),app.use(bodyParser.urlencoded({extended:!0})),app.use(passport.initialize()),app.use(passport.session());const port=3e3;app.listen(port,function(e){e?console.log(e):console.log("Server Started At Port "+port)}),app.get("/",(e,o)=>{o.render("index")}),app.post("/",(e,o)=>{new Post({image_link:e.body.image_link,author_name:e.body.author,content:e.body.content,portfolio:e.body.portfolio,contact:e.body.contact}).save().then(e=>{console.log(e),o.redirect("/")}).catch(e=>{if(e)throw e})}),app.get("/",(e,o)=>{Post.find().sort({createdAt:"descending"}).then(e=>{e&&o.render("index",{allpost:e})}).catch(e=>{if(e)throw e})}),app.post("/",(s,r)=>{User.register(new User({username:s.body.username,firstName:s.body.firstName,lastName:s.body.lastName}),s.body.password,function(e,o){e&&console.log(e),passport.authenticate("local")(s,r,function(){console.log(s),r.redirect("/")})})}),app.post("/login",passport.authenticate("local",{successRedirect:"/",failureRedirect:"/"})),app.get("/logout",(e,o)=>{e.logout(),o.redirect("/")});